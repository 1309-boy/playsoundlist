name: Convert Mojang Samples (FSB -> WAV)
on:
  workflow_dispatch:
  push:
    branches: [ main ]   # 커밋하면 자동 실행도 되게 함

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Fetch Mojang bedrock-samples (sounds only)
        run: |
          set -e
          git clone --depth=1 https://github.com/Mojang/bedrock-samples.git
          mkdir -p mojang_sounds
          cp -a bedrock-samples/resource_pack/sounds/. mojang_sounds/

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config git \
            libmpg123-dev libvorbis-dev libogg-dev libopusfile-dev \
            libavcodec-dev libavformat-dev libavutil-dev libswresample-dev \
            jq python3 ffmpeg

      - name: Build vgmstream (CLI)
        run: |
          set -e
          git clone --depth=1 https://github.com/vgmstream/vgmstream.git
          cd vgmstream
          make -j"$(nproc)" CFLAGS="-O2"
          cp vgmstream-cli ../vgmstream-cli
          cd ..
          ./vgmstream-cli -h || true

      - name: Convert FSB -> WAV (flatten)
        run: |
          set -e
          mkdir -p out
          find mojang_sounds -type f -name '*.fsb' -print0 | while IFS= read -r -d '' f; do
            rel="${f#mojang_sounds/}"       # ui/loom/take_result1.fsb
            noext="${rel%.fsb}"             # ui/loom/take_result1
            base="${noext//\//.}"           # ui.loom.take_result1
            ./vgmstream-cli -D "$f" -o "out/${base}.wav" >/dev/null || true
          done
          ls -l out | head || true
          if ! ls out/*.wav >/dev/null 2>&1; then
            echo "No WAVs produced." >&2
            exit 1
          fi

      - name: Create manifest.json (minecraft:<id>)
        shell: python
        run: |
          import os, json
          items = []
          for fn in sorted(os.listdir('out')):
              if not fn.lower().endswith(('.wav','.ogg')): continue
              base, ext = os.path.splitext(fn)
              items.append({"id": f"minecraft:{base}", "label": base, "url": f"./{fn}"})
          with open('out/manifest.json','w',encoding='utf-8') as f:
              json.dump(items, f, ensure_ascii=False, indent=2)
          print("Wrote out/manifest.json with", len(items), "entries")

      - name: Commit to repo (sounds_flat/)
        run: |
          set -e
          mkdir -p sounds_flat
          rm -rf sounds_flat/*
          cp -a out/. sounds_flat/
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add sounds_flat
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto: Convert Mojang FSB -> WAV + manifest"
            git push
          fi

      - name: Upload artifact (optional download)
        uses: actions/upload-artifact@v4
        with:
          name: sounds_flat
          path: out/
