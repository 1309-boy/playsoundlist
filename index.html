<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bedrock Playsound 리스트</title>
<style>
body {
  font-family: system-ui, sans-serif;
  margin: 20px;
  background: #fafafa;
}
header {
  font-size: 1.3em;
  font-weight: bold;
  margin-bottom: 10px;
}
input {
  padding: 5px;
  width: 320px;
}
.sound {
  background: #fff;
  border-radius: 10px;
  padding: 10px 14px;
  margin-bottom: 10px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.controls {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 6px;
}
button {
  background: black;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 5px;
  cursor: pointer;
}
button:disabled { background: #aaa; }
nav { margin-top: 15px; }
</style>
</head>

<body>
<header>Bedrock Playsound 리스트</header>
<div id="decoder-status">FSB를 클라이언트에서 디코딩(옵션). <small id="decoder-label">Decoder: loaded</small></div>
<br>

<input id="search" placeholder="검색: ui.loom / zombie / ambient …" oninput="applyFilter()">
<button onclick="loadManifest()">manifest 다시 불러오기</button>
<div id="list"></div>

<nav>
  <button onclick="prevPage()">◀ 이전</button>
  <button onclick="nextPage()">다음 ▶</button>
  <span id="pageInfo"></span>
</nav>

<script>
let manifestEntries = [];
let filtered = [];
let page = 1;
const pageSize = 100;

async function loadManifest() {
  const url = `./manifest.json?ts=${Date.now()}`; // 루트의 manifest.json만 읽기
  console.log("📦 fetch manifest:", url);
  try {
    const res = await fetch(url);
    if (!res.ok) {
      console.error("manifest fetch 실패", res.status);
      document.getElementById("decoder-label").innerText = "manifest 로드 실패";
      return;
    }
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); }
    catch(e) {
      console.error("JSON 파싱 실패:", e);
      document.getElementById("decoder-label").innerText = "JSON 파싱 오류";
      return;
    }

    manifestEntries = Array.isArray(data) ? data : (data.entries || []);
    console.log("entries:", manifestEntries.length);
    document.getElementById("decoder-label").innerText = `Loaded (${manifestEntries.length})`;
    applyFilter();
  } catch (err) {
    console.error(err);
    document.getElementById("decoder-label").innerText = "fetch 오류";
  }
}

function applyFilter() {
  const q = document.getElementById("search").value.toLowerCase().trim();
  filtered = manifestEntries.filter(e =>
    e.id.toLowerCase().includes(q) || e.label.toLowerCase().includes(q)
  );
  page = 1;
  renderPage();
}

function renderPage() {
  const start = (page - 1) * pageSize;
  const slice = filtered.slice(start, start + pageSize);
  const list = document.getElementById("list");
  list.innerHTML = "";

  for (const e of slice) {
    const div = document.createElement("div");
    div.className = "sound";
    div.innerHTML = `
      <b>${e.label}</b><br>
      <small>${e.id}</small>
      <div class="controls">
        Pitch <input type="range" min="0.5" max="2" step="0.01" value="1" class="pitch">
        <span class="pitchVal">1.00</span>
        <button class="play">▶ Play</button>
        <button class="copy">Copy /playsound</button>
      </div>`;
    const pitch = div.querySelector(".pitch");
    const pitchVal = div.querySelector(".pitchVal");
    const playBtn = div.querySelector(".play");
    const copyBtn = div.querySelector(".copy");

    pitch.oninput = () => pitchVal.textContent = parseFloat(pitch.value).toFixed(2);

    playBtn.onclick = async () => {
      try {
        const res = await fetch(e.url);
        if (!res.ok) throw new Error("fetch 실패");
        const arr = await res.arrayBuffer();
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const buf = await ctx.decodeAudioData(arr);
        const src = ctx.createBufferSource();
        src.buffer = buf;
        src.playbackRate.value = parseFloat(pitch.value);
        src.connect(ctx.destination);
        src.start();
      } catch (err) {
        alert(`재생 실패: ${err.message}`);
      }
    };

    copyBtn.onclick = () => {
      const cmd = `/playsound ${e.id} @p`;
      navigator.clipboard.writeText(cmd);
      copyBtn.textContent = "Copied!";
      setTimeout(() => copyBtn.textContent = "Copy /playsound", 1000);
    };

    list.appendChild(div);
  }

  document.getElementById("pageInfo").textContent =
    `총 ${filtered.length}개 / ${page} 페이지`;
}

function nextPage() {
  if (page * pageSize < filtered.length) { page++; renderPage(); }
}
function prevPage() {
  if (page > 1) { page--; renderPage(); }
}

loadManifest();
</script>
</body>
</html>
