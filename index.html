<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Playsound 리스트</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #111;
      color: #ddd;
      margin: 0;
      padding: 10px;
    }
    h1 { font-size: 1.4em; margin-bottom: 10px; }
    input, button { font-size: 1em; }
    .sound { background: #222; margin: 6px 0; padding: 8px; border-radius: 6px; }
    .title { font-weight: bold; color: #fff; margin-bottom: 6px; }
    .pitch-control { display: flex; align-items: center; gap: 8px; margin-top: 6px; }
    input[type=range] { flex: 1; }
    .controls { margin-top: 6px; }
    button { background: #444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; }
    button:hover { background: #666; }
    .top-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Playsound 리스트 <span id="total"></span></h1>
  <div class="top-bar">
    <input id="search" placeholder="이벤트 이름 검색 (예: beacon.power, ui.loom ...)" />
    <button id="reload">manifest 다시 불러오기</button>
  </div>

  <div id="list"></div>

  <div style="margin-top:10px;">
    <button id="prev">◀ 이전</button>
    <button id="next">다음 ▶</button>
    <span id="pageinfo"></span>
  </div>

  <p id="decoderStatus" style="opacity:0.6;font-size:0.9em;">Decoder: loaded</p>

  <script>
  const BASE = window.location.pathname.replace(/\/[^/]*$/, '');
  const DEFINITIONS_URL = `${BASE}/sound_definitions.txt`;
  const MANIFEST_URL = `${BASE}/manifest.json`;
  const PAGE_SIZE = 100;
  const listDiv = document.getElementById('list');
  const searchInput = document.getElementById('search');
  const pageInfo = document.getElementById('pageinfo');
  const totalSpan = document.getElementById('total');
  const state = { items: [], filtered: [], page: 1, audio:null };

  async function loadText(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(res.status);
    return await res.text();
  }
  async function loadJSON(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(res.status);
    return await res.json();
  }

  async function loadAll(){
    try{
      const text = await loadText(DEFINITIONS_URL);
      const parsed = parseDefinitions(text);
      if (parsed.length > 0) {
        state.items = parsed;
      } else {
        const man = await loadJSON(MANIFEST_URL);
        state.items = buildFromManifest(man);
      }
    }catch{
      const man = await loadJSON(MANIFEST_URL);
      state.items = buildFromManifest(man);
    }

    state.filtered = state.items.slice();
    totalSpan.textContent = `총 ${state.items.length}개 이벤트`;
    state.page = 1;
    render();
  }

  function parseDefinitions(text){
    text = text.replace(/^\uFEFF/, '');
    const map = new Map();
    for (const raw of text.split(/\r?\n/)) {
      let line = raw.trim();
      if (!line || line.startsWith('#') || line.startsWith('//')) continue;
      line = line.replace(/\s*(#|\/\/).*$/, '').trim();
      if (!line) continue;

      if (line.includes('->')) {
        const [lhs, rhs] = line.split('->').map(s=>s.trim());
        if (!lhs || !rhs) continue;
        const path = lhs.replace(/^(\.\/)?(sounds_flat\/)?/,'');
        const eventId = rhs.replace(/^minecraft:/,'');
        if (!map.has(eventId)) map.set(eventId,new Set());
        map.get(eventId).add(path);
        continue;
      }

      if (line.includes('=')) {
        const [lhs, rhs] = line.split('=').map(s=>s.trim());
        if (!lhs || !rhs) continue;
        const eventId = lhs.replace(/^minecraft:/,'');
        const parts = rhs.split(/[,\|]/).map(s=>s.trim()).filter(Boolean);
        if (!map.has(eventId)) map.set(eventId,new Set());
        const set = map.get(eventId);
        parts.forEach(p => set.add(p.replace(/^(\.\/)?(sounds_flat\/)?/,'') ));
        continue;
      }
    }
    const items=[];
    for (const [eventId, set] of map) {
      const files = [...set].map(p => ({
        url: normalizePath(p),
        label: p.split('/').pop()
      }));
      items.push({eventId, title: labelFromEventId(eventId), files});
    }
    items.sort((a,b)=>a.title.localeCompare(b.title,'en'));
    return items;
  }

  function normalizePath(p){
    if (!p.endsWith('.wav')) return `${BASE}/sounds_flat/${p}.wav`;
    return `${BASE}/sounds_flat/${p}`;
  }

  function buildFromManifest(man){
    const arr = man.entries?.map(e=>({
      eventId: e.id?.replace(/^minecraft:/,'') || e.label || e.url,
      title: e.label || e.id || e.url,
      files: [{url: `${BASE}/${e.url}`, label: e.url.split('/').pop()}]
    })) || [];
    arr.sort((a,b)=>a.title.localeCompare(b.title,'en'));
    return arr;
  }

  function labelFromEventId(id){
    return id.replace(/^minecraft:/,'');
  }

  function render(){
    const start=(state.page-1)*PAGE_SIZE, end=start+PAGE_SIZE;
    const slice=state.filtered.slice(start,end);
    listDiv.innerHTML='';
    for (const s of slice){
      const div=document.createElement('div');
      div.className='sound';
      div.innerHTML=`
        <div class="title">${s.title}</div>
        <div class="controls">
          <button class="play">▶ 재생</button>
          <button class="stop">■ 정지</button>
        </div>
        <div class="pitch-control">
          <label>피치:</label>
          <input type="range" min="0.1" max="2.0" step="0.1" value="1" class="pitch">
          <span class="pval">1.0</span>
        </div>`;
      listDiv.appendChild(div);

      const playBtn=div.querySelector('.play');
      const stopBtn=div.querySelector('.stop');
      const pitch=div.querySelector('.pitch');
      const pval=div.querySelector('.pval');
      playBtn.onclick=()=>play(s.files[0].url,parseFloat(pitch.value));
      stopBtn.onclick=()=>{if(state.audio){state.audio.pause();state.audio=null}};
      pitch.oninput=()=>pval.textContent=pitch.value;
    }
    pageInfo.textContent=`총 ${state.filtered.length}개 / ${Math.ceil(state.filtered.length/PAGE_SIZE)}페이지 중 ${state.page}페이지`;
  }

  async function play(url,rate){
    try{
      if(state.audio){state.audio.pause();}
      const audio=new Audio(url);
      audio.preservesPitch=false;
      audio.playbackRate=rate;
      await audio.play();
      state.audio=audio;
    }catch(err){
      alert(`재생 실패: ${err.message}\nURL: ${url}`);
    }
  }

  searchInput.addEventListener('input',()=>{
    const q=searchInput.value.toLowerCase();
    state.filtered=state.items.filter(s=>s.title.toLowerCase().includes(q));
    state.page=1; render();
  });
  document.getElementById('next').onclick=()=>{if(state.page*PAGE_SIZE<state.filtered.length){state.page++;render();}};
  document.getElementById('prev').onclick=()=>{if(state.page>1){state.page--;render();}};
  document.getElementById('reload').onclick=()=>loadAll();

  loadAll();
  </script>
</body>
</html>
