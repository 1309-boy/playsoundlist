<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Playsound 리스트</title>
<style>
  :root { --fg:#111; --muted:#666; --card:#fff; --bg:#f4f5f7; --accent:#2563eb; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Helvetica,Arial,sans-serif}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  h1{font-size:24px;margin:0 0 12px}
  .meta{color:var(--muted);margin-left:8px;font-weight:600}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0 18px}
  .search{flex:1;min-width:220px}
  .search input{width:100%;box-sizing:border-box;padding:12px 14px;border:1px solid #d0d7de;border-radius:10px;background:#fff;font-size:14px}
  .reload{padding:10px 12px;border:1px solid #d0d7de;border-radius:10px;background:#fff;font-weight:600;cursor:pointer}
  .pager{display:flex;gap:8px;margin:8px 0 18px}
  .pager button{padding:8px 10px;border:1px solid #d0d7de;border-radius:8px;background:#fff;cursor:pointer}
  .grid{display:flex;flex-direction:column;gap:12px}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:14px}
  .title{font-weight:700;margin-bottom:10px;word-break:break-all}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .btn{padding:10px 14px;border:1px solid #d0d7de;border-radius:10px;background:#fff;font-weight:700;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .range-row{display:flex;align-items:center;gap:10px;margin-top:10px}
  .label{color:var(--muted);font-weight:600}
  input[type="range"]{flex:1}
  .small{color:var(--muted);font-size:12px;margin-left:6px}
  .muted{color:var(--muted)}
  .hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>Playsound 리스트 <span id="total" class="meta"></span></h1>

  <div class="toolbar">
    <div class="search"><input id="q" placeholder="이벤트 이름 검색 (예: beacon.power, ui.loom, zombie …)" /></div>
    <button id="btnReload" class="reload">manifest 다시 불러오기</button>
    <div id="decoderState" class="muted">Decoder: <b>loaded</b></div>
  </div>

  <div class="pager">
    <button id="prev">◀ 이전</button>
    <button id="next">다음 ▶</button>
    <div class="small" id="pageInfo"></div>
  </div>

  <div id="list" class="grid"></div>

  <div class="pager">
    <button id="prev2">◀ 이전</button>
    <button id="next2">다음 ▶</button>
    <div class="small" id="pageInfo2"></div>
  </div>
</div>

<script>
/* ───────────────────────── 1) Manifest 로딩 & 경로 처리 ───────────────────────── */
let manifestUrlUsed = null; // 실제 내려온 manifest URL
async function loadManifest() {
  const candidates = [
    'sounds_flat/manifest.json',
    '/playsoundlist/sounds_flat/manifest.json',
    '/sounds_flat/manifest.json'
  ];
  let lastErr;
  for (const u of candidates) {
    try {
      const r = await fetch(u, { cache:'no-store' });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      manifestUrlUsed = r.url; // 중요: 실주소 기록
      return await r.json();
    } catch (e) { lastErr = e; }
  }
  throw new Error('manifest 로드 실패');
}

function absoluteFromManifest(rel) {
  try {
    const base = manifestUrlUsed ?? location.href;
    const baseDir = base.replace(/manifest\.json.*$/i, '');
    return new URL(rel, baseDir).href;
  } catch (e) {
    return rel.startsWith('/') ? rel : '/' + rel;
  }
}

/* ───────────────────────── 2) 디스플레이용 이름 가공/그룹 ───────────────────────── */
function prettyNameFromLabel(label) {
  // label: "ambient/nether/…/mood1" → "ambient.nether.….mood1"
  // minecraft: 접두사 제거 + / → .
  let name = (label || '').replace(/^minecraft:/,'').replace(/\//g,'.');
  return name;
}
// 숫자 버전 묶기: 끝이 ".1" ".2" 또는 "_1" "_2" 처럼 숫자만 달라지는 경우 베이스로 묶음
function groupKeyFromDisplayName(name) {
  return name.replace(/([._-])\d+$/,''); // 끝의 .3 / _2 / -4 등을 제거
}

/* ───────────────────────── 3) 오디오 재생 (모바일 호환, CORS 안전) ───────────────────────── */
let currentAudio = null;
async function playWavUrl(relUrl, playbackRate = 1.0, gain = 1.0) {
  const url = absoluteFromManifest(relUrl);
  try {
    const head = await fetch(url, { method:'HEAD', cache:'no-store' });
    if (!head.ok) throw new Error(`파일 접근 실패 (HTTP ${head.status})`);

    const res = await fetch(url, { cache:'no-store' });
    if (!res.ok) throw new Error(`다운로드 실패 (HTTP ${res.status})`);
    const blob = await res.blob();

    // 기존 재생 중이면 정지
    if (currentAudio) try { currentAudio.pause(); } catch {}
    currentAudio = new Audio();
    currentAudio.src = URL.createObjectURL(blob);
    currentAudio.crossOrigin = 'anonymous';
    currentAudio.preload = 'auto';
    currentAudio.playbackRate = playbackRate;
    currentAudio.volume = Math.max(0, Math.min(1, gain));

    currentAudio.onended = () => {
      URL.revokeObjectURL(currentAudio.src);
      currentAudio = null;
    };
    currentAudio.onerror = () => {
      try { URL.revokeObjectURL(currentAudio.src); } catch {}
      currentAudio = null;
    };
    await currentAudio.play();
  } catch (err) {
    alert(`재생에 실패했어요. 파일 경로나 브라우저 정책을 확인해 주세요.\n\n원인: ${err.message}\nURL: ${url}`);
    throw err;
  }
}

/* ───────────────────────── 4) 데이터 적재 & 렌더 ───────────────────────── */
let groups = [];         // [{ key, title, items:[entry…] }]
let filtered = [];
const PAGE_SIZE = 100;
let page = 0;

function buildGroups(entries) {
  const map = new Map();
  for (const e of entries) {
    // e: { id, label, url, type }
    const disp = prettyNameFromLabel(e.label || e.id || '');
    const key  = groupKeyFromDisplayName(disp);
    if (!map.has(key)) map.set(key, { key, title:key, items:[] });
    map.get(key).items.push({ ...e, disp });
  }
  // 타이틀 순 정렬
  const arr = Array.from(map.values()).sort((a,b)=>a.title.localeCompare(b.title));
  return arr;
}

function applyFilter(q) {
  q = (q||'').trim().toLowerCase();
  if (!q) { filtered = groups; return; }
  filtered = groups.filter(g => g.title.toLowerCase().includes(q));
}

function renderPage() {
  const start = page * PAGE_SIZE;
  const slice = filtered.slice(start, start + PAGE_SIZE);
  const list = document.getElementById('list');
  list.innerHTML = '';

  for (const g of slice) {
    // 한 카드엔 여러 변형(items)이 있을 수 있음 → 재생은 무작위로 하나 선택
    const randomItem = g.items[(Math.random()*g.items.length)|0];

    const card = document.createElement('div');
    card.className = 'card';

    const title = document.createElement('div');
    title.className = 'title';
    title.textContent = g.title;
    card.appendChild(title);

    const row = document.createElement('div');
    row.className = 'row';
    const btnPlay = document.createElement('button');
    btnPlay.className = 'btn';
    btnPlay.textContent = '▶ 재생';
    const btnStop = document.createElement('button');
    btnStop.className = 'btn';
    btnStop.textContent = '■ 정지';

    row.appendChild(btnPlay);
    row.appendChild(btnStop);
    card.appendChild(row);

    const range = document.createElement('input');
    range.type = 'range';
    range.min = '0.1';
    range.max = '2.0';
    range.step = '0.1';
    range.value = '1.0';

    const rr = document.createElement('div');
    rr.className = 'range-row';
    const lab = document.createElement('div');
    lab.className = 'label';
    lab.textContent = '피치:';
    const val = document.createElement('div');
    val.className = 'small';
    val.textContent = '1.0';

    range.addEventListener('input', ()=> { val.textContent = Number(range.value).toFixed(1); });

    rr.appendChild(lab);
    rr.appendChild(range);
    rr.appendChild(val);
    card.appendChild(rr);

    btnPlay.addEventListener('click', async () => {
      // 매번 변형 중 하나를 골라 재생
      const item = g.items[(Math.random()*g.items.length)|0];
      await playWavUrl(item.url, parseFloat(range.value), 1.0);
    });
    btnStop.addEventListener('click', () => { try { currentAudio?.pause(); } catch{} });

    list.appendChild(card);
  }

  // 상단/하단 페이지 정보
  const pageInfo = `${filtered.length.toLocaleString()}개 / ${page+1} / ${Math.max(1, Math.ceil(filtered.length / PAGE_SIZE))}`;
  document.getElementById('pageInfo').textContent  = pageInfo;
  document.getElementById('pageInfo2').textContent = pageInfo;
  document.getElementById('total').textContent = `총 ${groups.reduce((n,g)=>n+g.items.length,0).toLocaleString()}개 이벤트`;
}

async function boot(reload=false) {
  try {
    const data = await loadManifest();
    const entries = Array.isArray(data?.entries) ? data.entries : [];
    groups = buildGroups(entries);
    applyFilter(document.getElementById('q').value);
    page = 0;
    renderPage();
  } catch (e) {
    alert('manifest 로드 실패');
    console.error(e);
  }
}

/* ───────────────────────── 5) 이벤트 바인딩 ───────────────────────── */
document.getElementById('q').addEventListener('input', () => {
  applyFilter(document.getElementById('q').value);
  page = 0;
  renderPage();
});
function goto(delta){
  const maxPage = Math.max(0, Math.ceil(filtered.length / PAGE_SIZE) - 1);
  page = Math.min(maxPage, Math.max(0, page + delta));
  renderPage();
}
document.getElementById('prev').onclick  = ()=>goto(-1);
document.getElementById('next').onclick  = ()=>goto(1);
document.getElementById('prev2').onclick = ()=>goto(-1);
document.getElementById('next2').onclick = ()=>goto(1);
document.getElementById('btnReload').onclick = ()=>boot(true);

// 시작!
boot();
</script>
</body>
</html>
