<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Playsound 리스트</title>
<style>
  :root{
    --bg:#121212; --panel:#1c1c1c; --muted:#9aa0a6; --text:#e8eaed; --accent:#4dabf7; --btn:#2a2a2a;
    --card:#181818; --border:#2c2c2c;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, Helvetica, Arial, sans-serif;}
  .wrap{max-width:980px;margin:0 auto;padding:16px;}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  .toolbar .title{font-weight:700;font-size:18px;margin-right:auto}
  input[type="search"]{flex:1 min(360px);background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:10px}
  button, select{background:var(--btn);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 10px;cursor:pointer}
  button:hover{border-color:#3a3a3a}
  .small{font-size:12px;color:var(--muted)}
  .status{margin-left:6px;font-size:12px;color:#9acd6a}
  .list{display:flex;flex-direction:column;gap:10px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .card .head{display:flex;align-items:center;gap:8px;margin-bottom:6px}
  .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .row label{color:var(--muted);font-size:12px}
  .row input[type="range"]{flex:1;accent-color:var(--accent)}
  .muted{color:var(--muted)}
  .pager{display:flex;align-items:center;gap:8px;margin:12px 0}
  .hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div class="title">Playsound 리스트 <span id="total" class="small"></span></div>
    <input id="q" type="search" placeholder="이벤트 이름 검색 (예: beacon.pow, ui.loom ...)" />
    <select id="pagesize">
      <option value="50">페이지당 50개</option>
      <option value="100" selected>페이지당 100개</option>
      <option value="200">페이지당 200개</option>
    </select>
    <button id="reload">manifest 다시 불러오기</button>
    <span id="decoderState" class="status">Decoder: loaded</span>
  </div>

  <div class="pager">
    <button id="prev">&lt; 이전</button>
    <button id="next">다음 &gt;</button>
    <div class="small"><span id="pageInfo"></span></div>
  </div>

  <div id="list" class="list"></div>

  <div class="pager">
    <button id="prev2">&lt; 이전</button>
    <button id="next2">다음 &gt;</button>
    <div class="small"><span id="pageInfo2"></span></div>
  </div>
</div>

<script>
/* ------------------------------ 데이터 소스 ------------------------------ */
const MANIFEST_URL = './manifest.json';           // { entries:[{url:'sounds_flat/...wav', id:'minecraft:xxx', ...}, ...] }
const DEFINITIONS_URL = './sound_definitions.json'; // { "ambient.underwater.exit": { sounds:[ "sounds/ambient/underwater/exit1", {...}, ... ] }, ... }

/* ------------------------------ 상태 ------------------------------ */
const state = {
  manifestSet: new Set(),  // 'sounds_flat/.../foo.wav'
  items: [],               // [{name:'ambient.underwater.exit', files:['sounds_flat/.../exit1.wav', ...], stream:bool}]
  filtered: [],
  page: 1,
  pageSize: parseInt(localStorage.getItem('pagesize')||'100',10),
  playing: new Map(),      // name -> { node, gain, source, currentIdx }
  ctx: null
};

function getAudioCtx(){
  if(!state.ctx){
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    state.ctx = new AudioCtx();
  }
  return state.ctx;
}

/* ------------------------------ 유틸 ------------------------------ */
const sleep = ms => new Promise(r=>setTimeout(r,ms));

function normalizeDefSound(s){
  // s: string OR {name: string, ...}
  if(typeof s === 'string') return s;
  if(s && typeof s.name === 'string') return s.name;
  return null;
}
function soundsToWavs(path){ // "sounds/ambient/underwater/exit1" -> "sounds_flat/ambient/underwater/exit1.wav"
  if(!path) return null;
  return path.replace(/^sounds\//,'sounds_flat/') + '.wav';
}
function existsInManifest(url){
  return state.manifestSet.has(url);
}

/* ------------------------------ 렌더러 ------------------------------ */
const $list = document.getElementById('list');
const $q = document.getElementById('q');
const $total = document.getElementById('total');
const $pageInfo = document.getElementById('pageInfo');
const $pageInfo2 = document.getElementById('pageInfo2');
const $pagesize = document.getElementById('pagesize');
$pagesize.value = String(state.pageSize);

function setCounts(){
  $total.textContent = `총 ${state.filtered.length}개 이벤트`;
  const pages = Math.max(1, Math.ceil(state.filtered.length / state.pageSize));
  state.page = Math.min(state.page, pages);
  const info = `${state.filtered.length ? state.page : 0} / ${pages} 페이지`;
  $pageInfo.textContent = info;
  $pageInfo2.textContent = info;
}

function render(){
  setCounts();
  $list.innerHTML = '';
  if(state.filtered.length===0){ return; }

  const start = (state.page-1)*state.pageSize;
  const end = Math.min(start + state.pageSize, state.filtered.length);
  for(let i=start;i<end;i++){
    const it = state.filtered[i];
    const card = document.createElement('div');
    card.className = 'card';

    const head = document.createElement('div');
    head.className = 'head';
    head.innerHTML = `<div class="name">${it.name}</div>`;
    card.appendChild(head);

    // 버튼들
    const row1 = document.createElement('div');
    row1.className = 'row';
    const playBtn = document.createElement('button');
    playBtn.textContent = '▶ 재생';
    const stopBtn = document.createElement('button');
    stopBtn.textContent = '■ 정지';
    row1.append(playBtn, stopBtn);
    card.appendChild(row1);

    // 피치
    const row2 = document.createElement('div');
    row2.className = 'row';
    const label = document.createElement('label');
    label.textContent = '피치:';
    const pitch = document.createElement('input');
    pitch.type = 'range'; pitch.min='0.1'; pitch.max='2.0'; pitch.step='0.1'; pitch.value='1.0';
    const pv = document.createElement('span'); pv.className='muted'; pv.textContent = '1.0';
    row2.append(label, pitch, pv);
    card.appendChild(row2);

    // 이벤트 바인딩
    playBtn.addEventListener('click', ()=> playItem(it.name, parseFloat(pitch.value)));
    stopBtn.addEventListener('click', ()=> stopItem(it.name));
    pitch.addEventListener('input', ()=>{
      pv.textContent = pitch.value;
      // 실시간 변경
      const p = state.playing.get(it.name);
      if(p && p.source) p.source.playbackRate.value = parseFloat(pitch.value);
    });

    $list.appendChild(card);
  }
}

/* ------------------------------ 재생 로직 ------------------------------ */
async function fetchArrayBuffer(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return await r.arrayBuffer();
}

async function decodeBuffer(ab){
  const ctx = getAudioCtx();
  return await ctx.decodeAudioData(ab);
}

async function playItem(name, rate=1.0){
  // 후보 파일들
  const it = state.itemsByName.get(name);
  if(!it || !it.files || !it.files.length){
    alert('재생 실패: 대상 파일이 없습니다.'); return;
  }

  // 이전 소스 정리
  stopItem(name);

  // 라운드로빈으로 선택
  let idx = 0;
  if(state.playing.has(name)) {
    const prev = state.playing.get(name);
    idx = (prev.currentIdx + 1) % it.files.length;
  }
  const url = it.files[idx];

  try{
    const ab = await fetchArrayBuffer(url);
    const buf = await decodeBuffer(ab);
    const ctx = getAudioCtx();
    const src = ctx.createBufferSource();
    src.buffer = buf;
    src.playbackRate.value = rate;
    const gain = ctx.createGain();
    gain.gain.value = 1;
    src.connect(gain).connect(ctx.destination);
    src.start(0);

    const rec = { source: src, gain, currentIdx: idx };
    state.playing.set(name, rec);

    src.onended = ()=> {
      // 자동 루프가 필요하면 여기서 다음 파일 이어붙이는 로직 가능
      state.playing.delete(name);
    };
  }catch(err){
    console.error(err);
    alert(`재생에 실패했어요. 파일 경로나 브라우저 정책을 확인해 주세요.\n\n원인: ${err.message}\nURL: ${url}`);
  }
}

function stopItem(name){
  const p = state.playing.get(name);
  if(p && p.source){
    try{ p.source.stop(0); }catch(_){}
  }
  state.playing.delete(name);
}

/* ------------------------------ 필터 & 페이지 ------------------------------ */
function applyFilter(){
  const q = $q.value.trim().toLowerCase();
  if(!q) state.filtered = state.items.slice();
  else state.filtered = state.items.filter(x => x.name.toLowerCase().includes(q));
  state.page = 1;
  render();
}

document.getElementById('prev').onclick = document.getElementById('prev2').onclick = ()=>{
  if(state.page>1){ state.page--; render(); }
};
document.getElementById('next').onclick = document.getElementById('next2').onclick = ()=>{
  const pages = Math.max(1, Math.ceil(state.filtered.length/state.pageSize));
  if(state.page < pages){ state.page++; render(); }
};
$q.addEventListener('input', ()=>{ applyFilter(); });
$pagesize.addEventListener('change', ()=>{
  state.pageSize = parseInt($pagesize.value,10);
  localStorage.setItem('pagesize', String(state.pageSize));
  render();
});
document.getElementById('reload').onclick = async ()=>{
  await loadAll(true);
  applyFilter();
};

/* ------------------------------ 로딩 ------------------------------ */
async function loadManifest(){
  // manifest.json 의 url들을 Set으로
  const r = await fetch(MANIFEST_URL, {cache:'no-store'});
  if(!r.ok) throw new Error(`manifest 로드 실패: HTTP ${r.status}`);
  const j = await r.json();
  const urls = (j.entries||[]).map(e=>e.url).filter(Boolean);
  state.manifestSet = new Set(urls);
}

async function loadDefinitions(){
  const r = await fetch(DEFINITIONS_URL, {cache:'no-store'});
  if(!r.ok) throw new Error(`sound_definitions 로드 실패: HTTP ${r.status}`);
  const defs = await r.json(); // 최상위가 { "ambient.xxx": { sounds:[...] }, ... }

  const items = [];
  const map = new Map();

  for(const [key, def] of Object.entries(defs)){
    if(!def || !Array.isArray(def.sounds)) continue;

    const files = def.sounds
      .map(normalizeDefSound)
      .map(soundsToWavs)
      .filter(Boolean)
      .filter(existsInManifest); // 실제로 존재하는 wav만 남김

    if(files.length===0) continue;

    items.push({ name: key, files, stream: !!def.stream });
    map.set(key, { files, stream: !!def.stream });
  }

  // 이름 오름차순 정렬
  items.sort((a,b)=> a.name.localeCompare(b.name));
  state.items = items;
  state.itemsByName = map;
}

async function loadAll(noCache=false){
  if(noCache){ await sleep(50); }
  await loadManifest();
  await loadDefinitions();
}

// 초기 실행
(async function init(){
  try{
    await loadAll();
    applyFilter();
  }catch(err){
    console.error(err);
    alert(err.message);
  }
})();
</script>
</body>
</html>
