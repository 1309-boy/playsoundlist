<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BE Playsound List</title>
<style>
  body {
    background-color: #111;
    color: #eee;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 1rem;
  }

  h1 {
    text-align: center;
    color: #90caf9;
  }

  .sound-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 12px;
    margin-top: 1rem;
  }

  .card {
    background-color: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 10px 12px;
    box-shadow: 0 0 5px #000;
  }

  .card .title {
    font-weight: bold;
    margin-bottom: 6px;
    color: #fff;
    overflow-wrap: anywhere;
  }

  .row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }

  .btn {
    padding: 5px 10px;
    border-radius: 8px;
    border: 1px solid #333;
    background-color: #2b2b2b;
    color: #eee;
    cursor: pointer;
    transition: all .2s;
  }

  .btn:hover {
    background-color: #444;
  }

  .btn.play.playing {
    background-color: #16a34a;
    color: #000;
    border-color: #16a34a;
  }

  .btn.stop {
    background-color: #3a3a3a;
  }

  .btn.stop:hover {
    background-color: #555;
  }

  input[type="range"] {
    width: 100px;
  }

  .pitch-val {
    min-width: 40px;
    text-align: center;
  }

  #search {
    display: block;
    margin: 0 auto;
    margin-bottom: 1rem;
    padding: .5rem;
    width: 300px;
    border-radius: 6px;
    border: none;
    outline: none;
  }

  #counter {
    text-align: center;
    color: #888;
    margin-bottom: 1rem;
  }
</style>
</head>
<body>

<h1>BE Playsound List</h1>
<input type="text" id="search" placeholder="Search sounds...">
<div id="counter">Loading sounds...</div>
<div id="sound-list" class="sound-list"></div>

<script>
  const MANIFEST_URL = 'https://1309-boy.github.io/playsoundlist/manifest.json';
  const DEFINITIONS_URL = 'https://1309-boy.github.io/playsoundlist/sound_definitions.json';
  const PAGE_SIZE = 100;

  let soundDefs = {};
  let allItems = [];
  let filtered = [];
  let currentPage = 0;

  let currentAudio = null;
  let currentPlayBtn = null;
  let currentItemKey = null;

  const listEl = document.getElementById('sound-list');
  const counterEl = document.getElementById('counter');

  // Pitch helper
  const getPitchFor = (key) => {
    const el = document.querySelector(`[data-key="${key}"] .pitch`);
    return el ? parseFloat(el.value || '1.0') : 1.0;
  };

  // Load sounds
  async function loadData() {
    const res = await fetch(DEFINITIONS_URL);
    const defs = await res.json();
    soundDefs = defs;

    allItems = Object.keys(defs).map(name => ({
      name,
      files: defs[name]?.sounds?.map(s => s.name.replace(/^sounds\//, '')) || []
    }));

    filtered = allItems;
    counterEl.textContent = `${allItems.length} sounds loaded`;
    renderPage(0);
  }

  // Render one page
  function renderPage(page) {
    currentPage = page;
    listEl.innerHTML = '';
    const start = page * PAGE_SIZE;
    const end = Math.min(start + PAGE_SIZE, filtered.length);
    const items = filtered.slice(start, end);

    for (const item of items) {
      const div = document.createElement('div');
      div.className = 'card';
      div.dataset.key = item.name;

      div.innerHTML = `
        <div class="title">${item.name}</div>
        <div class="row">
          <button class="btn play">Play</button>
          <button class="btn stop">Stop</button>
        </div>
        <div class="row">
          <label>Pitch:</label>
          <input type="range" min="0.1" max="2.0" step="0.1" value="1.0" class="pitch">
          <span class="pitch-val">1.0</span>
        </div>
      `;
      listEl.appendChild(div);
    }

    counterEl.textContent = `Showing ${start + 1}-${end} of ${filtered.length} sounds`;
  }

  // Filter
  document.getElementById('search').addEventListener('input', (e) => {
    const q = e.target.value.toLowerCase();
    filtered = allItems.filter(s => s.name.toLowerCase().includes(q));
    renderPage(0);
  });

  // Random/Sequential play picker (순차로 바꾸고 싶으면 여기를 수정)
  const playIndexMap = {};
  function pickNextUrlFor(key) {
    const item = allItems.find(s => s.name === key);
    if (!item || !item.files.length) return null;
    playIndexMap[key] = (playIndexMap[key] || 0) + 1;
    const i = (playIndexMap[key] - 1) % item.files.length;
    return `https://1309-boy.github.io/playsoundlist/sounds_flat/${item.files[i]}.wav`;
  }

  async function playItem(key, btn) {
    if (currentAudio) {
      try { currentAudio.pause(); } catch (e) {}
      if (currentPlayBtn) currentPlayBtn.classList.remove('playing');
      currentAudio = null;
      currentPlayBtn = null;
      currentItemKey = null;
    }

    const src = pickNextUrlFor(key);
    if (!src) {
      alert('Sound not found: ' + key);
      return;
    }

    const audio = new Audio(src);
    audio.playbackRate = getPitchFor(key);
    currentAudio = audio;
    currentPlayBtn = btn;
    currentItemKey = key;
    btn.classList.add('playing');

    audio.onended = () => {
      if (currentPlayBtn) currentPlayBtn.classList.remove('playing');
      currentAudio = null;
      currentPlayBtn = null;
      currentItemKey = null;
    };

    try {
      await audio.play();
    } catch (err) {
      alert('Playback blocked by browser. Click page first.');
      btn.classList.remove('playing');
    }
  }

  function stopItem(key) {
    if (currentAudio && currentItemKey === key) {
      try {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      } catch (e) {}
      if (currentPlayBtn) currentPlayBtn.classList.remove('playing');
      currentAudio = null;
      currentPlayBtn = null;
      currentItemKey = null;
    }
  }

  // Event delegation
  document.addEventListener('click', (e) => {
    const playBtn = e.target.closest('.btn.play');
    if (playBtn) {
      const card = playBtn.closest('.card');
      const key = card?.dataset?.key;
      if (key) playItem(key, playBtn);
      return;
    }

    const stopBtn = e.target.closest('.btn.stop');
    if (stopBtn) {
      const card = stopBtn.closest('.card');
      const key = card?.dataset?.key;
      if (key) stopItem(key);
      return;
    }
  });

  // Pitch change
  document.addEventListener('input', (e) => {
    if (e.target.matches('.pitch')) {
      const val = e.target.value;
      const card = e.target.closest('.card');
      const valEl = card.querySelector('.pitch-val');
      valEl.textContent = val;
      if (card?.dataset?.key === currentItemKey && currentAudio) {
        currentAudio.playbackRate = parseFloat(val);
      }
    }
  });

  loadData();
</script>
</body>
</html>
