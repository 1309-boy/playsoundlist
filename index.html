<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Playsound ë¦¬ìŠ¤íŠ¸</title>
<style>
  :root { --fg:#111; --muted:#666; --card:#fff; --bg:#f4f5f7; --accent:#2563eb; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Helvetica,Arial,sans-serif}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  h1{font-size:24px;margin:0 0 12px}
  .meta{color:var(--muted);margin-left:8px;font-weight:600}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0 18px}
  .search{flex:1;min-width:220px}
  .search input{width:100%;box-sizing:border-box;padding:12px 14px;border:1px solid #d0d7de;border-radius:10px;background:#fff;font-size:14px}
  .reload{padding:10px 12px;border:1px solid #d0d7de;border-radius:10px;background:#fff;font-weight:600;cursor:pointer}
  .pager{display:flex;gap:8px;margin:8px 0 18px}
  .pager button{padding:8px 10px;border:1px solid #d0d7de;border-radius:8px;background:#fff;cursor:pointer}
  .grid{display:flex;flex-direction:column;gap:12px}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:14px}
  .title{font-weight:700;margin-bottom:10px;word-break:break-all}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .btn{padding:10px 14px;border:1px solid #d0d7de;border-radius:10px;background:#fff;font-weight:700;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .range-row{display:flex;align-items:center;gap:10px;margin-top:10px}
  .label{color:var(--muted);font-weight:600}
  input[type="range"]{flex:1}
  .small{color:var(--muted);font-size:12px;margin-left:6px}
  .muted{color:var(--muted)}
  .hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>Playsound ë¦¬ìŠ¤íŠ¸ <span id="total" class="meta"></span></h1>

  <div class="toolbar">
    <div class="search"><input id="q" placeholder="ì´ë²¤íŠ¸ ì´ë¦„ ê²€ìƒ‰ (ì˜ˆ: beacon.power, ui.loom, zombie â€¦)" /></div>
    <button id="btnReload" class="reload">manifest ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <div id="decoderState" class="muted">Decoder: <b>loaded</b></div>
  </div>

  <div class="pager">
    <button id="prev">â—€ ì´ì „</button>
    <button id="next">ë‹¤ìŒ â–¶</button>
    <div class="small" id="pageInfo"></div>
  </div>

  <div id="list" class="grid"></div>

  <div class="pager">
    <button id="prev2">â—€ ì´ì „</button>
    <button id="next2">ë‹¤ìŒ â–¶</button>
    <div class="small" id="pageInfo2"></div>
  </div>
</div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1) Manifest ë¡œë”© & ê²½ë¡œ ì²˜ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let manifestUrlUsed = null; // ì‹¤ì œ ë‚´ë ¤ì˜¨ manifest URL
async function loadManifest() {
  const candidates = [
    'sounds_flat/manifest.json',
    '/playsoundlist/sounds_flat/manifest.json',
    '/sounds_flat/manifest.json'
  ];
  let lastErr;
  for (const u of candidates) {
    try {
      const r = await fetch(u, { cache:'no-store' });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      manifestUrlUsed = r.url; // ì¤‘ìš”: ì‹¤ì£¼ì†Œ ê¸°ë¡
      return await r.json();
    } catch (e) { lastErr = e; }
  }
  throw new Error('manifest ë¡œë“œ ì‹¤íŒ¨');
}

function absoluteFromManifest(rel) {
  try {
    const base = manifestUrlUsed ?? location.href;
    const baseDir = base.replace(/manifest\.json.*$/i, '');
    // ğŸ©µ "sounds_flat/sounds_flat/..." ì¤‘ë³µ ë°©ì§€
    const relFixed = rel.replace(/^sounds_flat\//, '');
    return new URL('sounds_flat/' + relFixed, baseDir).href;
  } catch (e) {
    return rel.startsWith('/') ? rel : '/' + rel;
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2) ë””ìŠ¤í”Œë ˆì´ìš© ì´ë¦„ ê°€ê³µ/ê·¸ë£¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function prettyNameFromLabel(label) {
  // label: "ambient/nether/â€¦/mood1" â†’ "ambient.nether.â€¦.mood1"
  // minecraft: ì ‘ë‘ì‚¬ ì œê±° + / â†’ .
  let name = (label || '').replace(/^minecraft:/,'').replace(/\//g,'.');
  return name;
}
// ìˆ«ì ë²„ì „ ë¬¶ê¸°: ëì´ ".1" ".2" ë˜ëŠ” "_1" "_2" ì²˜ëŸ¼ ìˆ«ìë§Œ ë‹¬ë¼ì§€ëŠ” ê²½ìš° ë² ì´ìŠ¤ë¡œ ë¬¶ìŒ
function groupKeyFromDisplayName(name) {
  return name.replace(/([._-])\d+$/,''); // ëì˜ .3 / _2 / -4 ë“±ì„ ì œê±°
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3) ì˜¤ë””ì˜¤ ì¬ìƒ (ëª¨ë°”ì¼ í˜¸í™˜, CORS ì•ˆì „) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let currentAudio = null;
async function playWavUrl(relUrl, playbackRate = 1.0, gain = 1.0) {
  const url = absoluteFromManifest(relUrl);
  try {
    const head = await fetch(url, { method:'HEAD', cache:'no-store' });
    if (!head.ok) throw new Error(`íŒŒì¼ ì ‘ê·¼ ì‹¤íŒ¨ (HTTP ${head.status})`);

    const res = await fetch(url, { cache:'no-store' });
    if (!res.ok) throw new Error(`ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (HTTP ${res.status})`);
    const blob = await res.blob();

    // ê¸°ì¡´ ì¬ìƒ ì¤‘ì´ë©´ ì •ì§€
    if (currentAudio) try { currentAudio.pause(); } catch {}
    currentAudio = new Audio();
    currentAudio.src = URL.createObjectURL(blob);
    currentAudio.crossOrigin = 'anonymous';
    currentAudio.preload = 'auto';
    currentAudio.playbackRate = playbackRate;
    currentAudio.volume = Math.max(0, Math.min(1, gain));

    currentAudio.onended = () => {
      URL.revokeObjectURL(currentAudio.src);
      currentAudio = null;
    };
    currentAudio.onerror = () => {
      try { URL.revokeObjectURL(currentAudio.src); } catch {}
      currentAudio = null;
    };
    await currentAudio.play();
  } catch (err) {
    alert(`ì¬ìƒì— ì‹¤íŒ¨í–ˆì–´ìš”. íŒŒì¼ ê²½ë¡œë‚˜ ë¸Œë¼ìš°ì € ì •ì±…ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.\n\nì›ì¸: ${err.message}\nURL: ${url}`);
    throw err;
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4) ë°ì´í„° ì ì¬ & ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let groups = [];         // [{ key, title, items:[entryâ€¦] }]
let filtered = [];
const PAGE_SIZE = 100;
let page = 0;

function buildGroups(entries) {
  const map = new Map();
  for (const e of entries) {
    // e: { id, label, url, type }
    const disp = prettyNameFromLabel(e.label || e.id || '');
    const key  = groupKeyFromDisplayName(disp);
    if (!map.has(key)) map.set(key, { key, title:key, items:[] });
    map.get(key).items.push({ ...e, disp });
  }
  // íƒ€ì´í‹€ ìˆœ ì •ë ¬
  const arr = Array.from(map.values()).sort((a,b)=>a.title.localeCompare(b.title));
  return arr;
}

function applyFilter(q) {
  q = (q||'').trim().toLowerCase();
  if (!q) { filtered = groups; return; }
  filtered = groups.filter(g => g.title.toLowerCase().includes(q));
}

function renderPage() {
  const start = page * PAGE_SIZE;
  const slice = filtered.slice(start, start + PAGE_SIZE);
  const list = document.getElementById('list');
  list.innerHTML = '';

  for (const g of slice) {
    // í•œ ì¹´ë“œì—” ì—¬ëŸ¬ ë³€í˜•(items)ì´ ìˆì„ ìˆ˜ ìˆìŒ â†’ ì¬ìƒì€ ë¬´ì‘ìœ„ë¡œ í•˜ë‚˜ ì„ íƒ
    const randomItem = g.items[(Math.random()*g.items.length)|0];

    const card = document.createElement('div');
    card.className = 'card';

    const title = document.createElement('div');
    title.className = 'title';
    title.textContent = g.title;
    card.appendChild(title);

    const row = document.createElement('div');
    row.className = 'row';
    const btnPlay = document.createElement('button');
    btnPlay.className = 'btn';
    btnPlay.textContent = 'â–¶ ì¬ìƒ';
    const btnStop = document.createElement('button');
    btnStop.className = 'btn';
    btnStop.textContent = 'â–  ì •ì§€';

    row.appendChild(btnPlay);
    row.appendChild(btnStop);
    card.appendChild(row);

    const range = document.createElement('input');
    range.type = 'range';
    range.min = '0.1';
    range.max = '2.0';
    range.step = '0.1';
    range.value = '1.0';

    const rr = document.createElement('div');
    rr.className = 'range-row';
    const lab = document.createElement('div');
    lab.className = 'label';
    lab.textContent = 'í”¼ì¹˜:';
    const val = document.createElement('div');
    val.className = 'small';
    val.textContent = '1.0';

    range.addEventListener('input', ()=> { val.textContent = Number(range.value).toFixed(1); });

    rr.appendChild(lab);
    rr.appendChild(range);
    rr.appendChild(val);
    card.appendChild(rr);

    btnPlay.addEventListener('click', async () => {
      // ë§¤ë²ˆ ë³€í˜• ì¤‘ í•˜ë‚˜ë¥¼ ê³¨ë¼ ì¬ìƒ
      const item = g.items[(Math.random()*g.items.length)|0];
      await playWavUrl(item.url, parseFloat(range.value), 1.0);
    });
    btnStop.addEventListener('click', () => { try { currentAudio?.pause(); } catch{} });

    list.appendChild(card);
  }

  // ìƒë‹¨/í•˜ë‹¨ í˜ì´ì§€ ì •ë³´
  const pageInfo = `${filtered.length.toLocaleString()}ê°œ / ${page+1} / ${Math.max(1, Math.ceil(filtered.length / PAGE_SIZE))}`;
  document.getElementById('pageInfo').textContent  = pageInfo;
  document.getElementById('pageInfo2').textContent = pageInfo;
  document.getElementById('total').textContent = `ì´ ${groups.reduce((n,g)=>n+g.items.length,0).toLocaleString()}ê°œ ì´ë²¤íŠ¸`;
}

async function boot(reload=false) {
  try {
    const data = await loadManifest();
    const entries = Array.isArray(data?.entries) ? data.entries : [];
    groups = buildGroups(entries);
    applyFilter(document.getElementById('q').value);
    page = 0;
    renderPage();
  } catch (e) {
    alert('manifest ë¡œë“œ ì‹¤íŒ¨');
    console.error(e);
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5) ì´ë²¤íŠ¸ ë°”ì¸ë”© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById('q').addEventListener('input', () => {
  applyFilter(document.getElementById('q').value);
  page = 0;
  renderPage();
});
function goto(delta){
  const maxPage = Math.max(0, Math.ceil(filtered.length / PAGE_SIZE) - 1);
  page = Math.min(maxPage, Math.max(0, page + delta));
  renderPage();
}
document.getElementById('prev').onclick  = ()=>goto(-1);
document.getElementById('next').onclick  = ()=>goto(1);
document.getElementById('prev2').onclick = ()=>goto(-1);
document.getElementById('next2').onclick = ()=>goto(1);
document.getElementById('btnReload').onclick = ()=>boot(true);

// ì‹œì‘!
boot();
</script>
</body>
</html>
