<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bedrock Playsound 리스트</title>
  <style>
    :root { --fg:#111; --muted:#666; --bg:#fff; --line:#e7e7e7; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--fg); background:var(--bg);}
    header { padding:16px; border-bottom:1px solid var(--line); display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    h1 { font-size:18px; margin:0; }
    #status { font-size:12px; color:var(--muted); }
    .toolbar { padding:12px 16px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; border-bottom:1px solid var(--line);}
    input[type="search"]{ flex:1 1 260px; padding:10px 12px; border:1px solid var(--line); border-radius:8px; font-size:14px; }
    button { padding:8px 12px; border:1px solid var(--line); background:#f7f7f7; border-radius:8px; cursor:pointer; }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .count { font-size:12px; color:var(--muted); margin-left:auto; }
    .list { padding:8px 16px 80px; }
    .row { display:grid; grid-template-columns:minmax(200px,1fr) auto 220px auto; gap:10px; align-items:center; padding:10px 0; border-bottom:1px solid var(--line);}
    .name { font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .pitch-wrap { display:flex; align-items:center; gap:8px;}
    .pitch-wrap input[type="range"]{ width:140px; }
    .pitch-val { width:44px; text-align:right; color:var(--muted); font-variant-numeric:tabular-nums; }
    .empty { padding:40px 16px; color:var(--muted); text-align:center; }
    .pager { display:flex; gap:6px; padding:12px 16px; border-top:1px solid var(--line); position:sticky; bottom:0; background:var(--bg);}
  </style>
</head>
<body>
  <header>
    <h1>Bedrock Playsound 리스트</h1>
    <span id="status" aria-live="polite">Decoder: <strong>loaded</strong></span>
  </header>

  <div class="toolbar">
    <input id="q" type="search" placeholder="검색: ui.loom / zombie / ambient …" />
    <button id="reload">manifest 다시 불러오기</button>
    <span class="count" id="meta"></span>
  </div>

  <div class="list" id="list"></div>

  <div class="pager">
    <button id="prev">&lt; 이전</button>
    <button id="next">다음 &gt;</button>
  </div>

<script>
const MANIFEST_URL = 'sounds_flat/manifest.json';
const PAGE_SIZE = 100;
let manifest = { entries: [] };
let filtered = [];
let page = 0;
let audioCtx;

const $ = sel => document.querySelector(sel);
const fmt = n => n.toLocaleString();

/* === 데이터 로드 === */
async function loadManifest() {
  const res = await fetch(MANIFEST_URL, { cache: 'no-store' });
  if (!res.ok) throw new Error('manifest fetch failed: ' + res.status);
  manifest = await res.json();
  manifest.entries.forEach(e => {
    e._label = (e.label || e.id || '').replace(/^minecraft:/, '');
  });
  applyFilter();
}

/* === 검색/페이지 === */
function applyFilter() {
  const q = $('#q').value.trim().toLowerCase();
  filtered = !q ? manifest.entries : manifest.entries.filter(e => e._label.toLowerCase().includes(q));
  page = 0;
  render();
}

function slicePage() {
  const start = page * PAGE_SIZE;
  return filtered.slice(start, start + PAGE_SIZE);
}

/* === 렌더링 === */
function render() {
  $('#meta').textContent =
    `총 ${fmt(filtered.length)}개 · ${fmt(page+1)}/${Math.max(1, Math.ceil(filtered.length/PAGE_SIZE))} 페이지`;
  const chunk = slicePage();
  const root = $('#list');
  root.innerHTML = '';

  if (chunk.length === 0) {
    root.innerHTML = `<div class="empty">표시할 사운드가 없습니다.</div>`;
    $('#prev').disabled = true; $('#next').disabled = true;
    return;
  }

  for (const item of chunk) {
    const row = document.createElement('div');
    row.className = 'row';

    const name = document.createElement('div');
    name.className = 'name';
    name.textContent = item._label;

    const pitchWrap = document.createElement('div');
    pitchWrap.className = 'pitch-wrap';
    const label = document.createElement('span');
    label.textContent = 'Pitch';
    const slider = document.createElement('input');
    slider.type = 'range';
    slider.min = '0.1';
    slider.max = '2.0';
    slider.step = '0.1';
    slider.value = '1.0';
    const val = document.createElement('span');
    val.className = 'pitch-val';
    val.textContent = '1.0×';
    slider.addEventListener('input', () => {
      val.textContent = Number(slider.value).toFixed(1) + '×';
    });
    pitchWrap.append(label, slider, val);

    const playBtn = document.createElement('button');
    playBtn.textContent = '▶ Play';
    playBtn.addEventListener('click', () => play(item.url, Number(slider.value)));

    row.append(name, pitchWrap, playBtn);
    root.appendChild(row);
  }

  $('#prev').disabled = (page === 0);
  $('#next').disabled = ((page+1)*PAGE_SIZE >= filtered.length);
}

/* === 재생 === */
async function play(url, pitch=1.0) {
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const res = await fetch(url);
    if (!res.ok) throw new Error('오디오 파일을 불러오지 못했습니다: ' + res.status);
    const buf = await res.arrayBuffer();
    const audioBuffer = await audioCtx.decodeAudioData(buf);
    const src = audioCtx.createBufferSource();
    src.buffer = audioBuffer;
    src.playbackRate.value = Math.min(2.0, Math.max(0.1, pitch));
    src.connect(audioCtx.destination);
    src.start(0);
  } catch (err) {
    alert('재생 실패: ' + err.message);
    console.error(err);
  }
}

/* === 이벤트 === */
$('#q').addEventListener('input', () => applyFilter());
$('#prev').addEventListener('click', () => { if (page>0){ page--; render(); } });
$('#next').addEventListener('click', () => { if ((page+1)*PAGE_SIZE < filtered.length){ page++; render(); } });
$('#reload').addEventListener('click', () => loadManifest().catch(e => alert('manifest 로드 실패\n' + e.message)));

loadManifest().catch(e => alert('manifest 로드 실패\n' + e.message));
</script>
</body>
</html>
